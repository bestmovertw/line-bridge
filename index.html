<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在開啟 LINE...</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #ffffff; }
        .btn { display: none; padding: 16px 40px; background: #00b900; color: #fff; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #loading { color: #888; font-size: 16px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div id="loading">正在開啟預約對話...</div>
    <a id="retryBtn" href="#" class="btn">點此手動開啟 LINE</a>

    <script>
        // --- 1. 基本設定 ---
        const LIFF_URL = "https://liff.line.me/2009064962-w2XqDG82"; 
        const LINE_URL = "https://line.me/R/ti/p/@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        // --- 2. 核心邏輯：防迴圈防火牆 ---
        // 如果網址後方帶有 #done，代表已經跳轉過一次，絕對不再跑自動邏輯
        if (window.location.hash === "#done") {
            showManualButton();
        } else {
            executeAutoRedirect();
        }

        async function executeAutoRedirect() {
            const params = new URLSearchParams(window.location.search);
            const gclid = params.get('gclid');
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // 1. 立即發送 GCLID (使用最穩定的非同步傳輸)
            if (gclid) {
                const payload = JSON.stringify({ gclid: gclid, source: 'Bridge_Final_v3' });
                // 使用 sendBeacon 確保跳轉時資料必傳且不卡頓
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(N8N_WEBHOOK, payload);
                } else {
                    fetch(N8N_WEBHOOK, { method: 'POST', mode: 'no-cors', body: payload, keepalive: true });
                }
            }

            // 2. 構造目標網址 (極簡化，防 URI Too Long)
            const baseTarget = isMobile ? LIFF_URL : LINE_URL;
            const finalRedirect = baseTarget + (gclid ? `?gclid=${encodeURIComponent(gclid)}` : "");

            // 3. 執行跳轉並加上防迴圈標記
            // 使用 replace 確保瀏覽器歷史紀錄不會一直堆疊
            window.location.replace(finalRedirect);

            // 4. 備援機制：如果 3 秒後還留在這頁 (通常是無痕模式)，顯示手動按鈕
            setTimeout(showManualButton, 3000);
        }

        function showManualButton() {
            document.getElementById('loading').style.display = 'none';
            const btn = document.getElementById('retryBtn');
            const params = new URLSearchParams(window.location.search);
            const gclid = params.get('gclid');
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            btn.href = (isMobile ? LIFF_URL : LINE_URL) + (gclid ? `?gclid=${encodeURIComponent(gclid)}` : "");
            btn.style.display = 'block';
            // 修改目前網址加上 #done 防止按鈕點擊後回彈又跳轉
            window.location.hash = "done";
        }
    </script>
</body>
</html>
