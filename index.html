      <!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在開啟 LINE...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <script>
        const LIFF_ID = "2009064962-w2XqDG82"; 
        const LINE_OA_ID = "@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const gclid = urlParams.get('gclid');

            // 1. 電腦版：直接跳轉 (維持不變)
            if (!isMobile) {
                if (gclid) {
                    fetch(N8N_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gclid: gclid, source: 'PC_Direct' })
                    }).catch(() => {});
                }
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                return;
            }

            // 2. 手機版：強制喚起 App 邏輯
            try {
                await liff.init({ liffId: LIFF_ID });
                
                // 如果沒登入，且在外部瀏覽器 (Chrome/Safari)
                if (!liff.isLoggedIn()) {
                    if (!liff.isInClient()) {
                        // 【關鍵修正】不使用 liff.login()，直接用 LINE 協定喚醒 App 並帶入參數
                        const currentUrl = window.location.href;
                        window.location.href = `https://liff.line.me/${LIFF_ID}?${urlParams.toString()}`;
                    } else {
                        liff.login();
                    }
                } else {
                    // 已在 LINE App 內或已登入
                    const profile = await liff.getProfile();
                    if (gclid) {
                        await fetch(N8N_WEBHOOK, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lineUserId: profile.userId,
                                lineName: profile.displayName,
                                gclid: gclid,
                                source: 'Mobile_Success'
                            })
                        });
                    }
                    window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                }
            } catch (err) {
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
            }
        }
        main();
    </script>
</body>
</html>
