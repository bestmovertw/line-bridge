<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在開啟 LINE...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <script>
        const LIFF_ID = "2009064962-w2XqDG82"; 
        const LINE_OA_ID = "@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        // 1. 立即判斷是否為電腦版 (不依賴 LIFF SDK)
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const gclid = urlParams.get('gclid');

            if (!isMobile) {
                // 【電腦版處理】直接暴力轉址到加好友 QR Code 頁面
                console.log("電腦版環境：直接跳轉");
                if (gclid) {
                    // 嘗試發送一次點擊紀錄給 n8n，但不論成功與否都跳轉
                    fetch(N8N_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gclid: gclid, source: 'PC_Direct_Jump' })
                    }).catch(() => {});
                }
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                return; 
            }

            // 2. 【手機版處理】走原本的 LIFF 邏輯
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    if (gclid) {
                        await fetch(N8N_WEBHOOK, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lineUserId: profile.userId,
                                lineName: profile.displayName,
                                gclid: gclid,
                                source: 'Mobile_LIFF_Success'
                            })
                        });
                    }
                    window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                }
            } catch (err) {
                console.error("LIFF 啟動失敗", err);
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
            }
        }

        main();
    </script>
</body>
</html>
