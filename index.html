<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>正在開啟預約系統...</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #ffffff;
    }
    .container {
      text-align: center;
      padding: 0 20px;
      max-width: 520px;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00b900;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    p {
      color: #555;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.7;
      margin: 0;
    }
    .hint {
      margin-top: 10px;
      font-size: 13px;
      font-weight: 500;
      color: #888;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="loader" class="loader"></div>
    <p id="status-text">正在為您開啟預約對話，請稍候...</p>
    <div class="hint" id="hint-text">（若停留過久，請返回重試或改用一般模式瀏覽）</div>
  </div>

  <script>
    // ===== 你的設定 =====
    const LIFF_ID   = "2009064962-w2XqDG82";
    const N8N_URL   = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";
    const LINE_OA_ID = "@138lkhjv";
    const HOME_URL  = "https://www.sweep-j.com/";

    // ===== 小工具 =====
    function setStatus(text) {
      const el = document.getElementById("status-text");
      if (el) el.textContent = text;
    }

    function getUAInfo() {
      const ua = navigator.userAgent || navigator.vendor || window.opera || "";
      const isLineBrowser = /Line/i.test(ua);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
      return { ua, isLineBrowser, isMobile };
    }

    function getAllParams() {
      const p = new URLSearchParams(location.search);

      // 先直接抓
      let gclid  = p.get("gclid");
      let gbraid = p.get("gbraid");
      let wbraid = p.get("wbraid");

      // 再從 liff.state 補抓（常見：liff.line.me 跳回 endpoint 時把 query 塞進 liff.state）
      const liffState = p.get("liff.state");
      if (liffState) {
        try {
          const decoded = decodeURIComponent(liffState);
          const qs = decoded.startsWith("?") ? decoded.slice(1) : decoded;
          const sp = new URLSearchParams(qs);

          gclid  = gclid  || sp.get("gclid");
          gbraid = gbraid || sp.get("gbraid");
          wbraid = wbraid || sp.get("wbraid");
        } catch (_) {}
      }

      // 也把其它你可能想記的帶上（可選）
      const utm_source = p.get("utm_source");
      const utm_medium = p.get("utm_medium");
      const utm_campaign = p.get("utm_campaign");

      return { gclid, gbraid, wbraid, utm_source, utm_medium, utm_campaign };
    }

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise(resolve => setTimeout(() => resolve(false), ms))
      ]);
    }

    function postToN8n(payload) {
      // 1) sendBeacon 優先（換頁前最穩）
      try {
        const ok = navigator.sendBeacon(
          N8N_URL,
          new Blob([JSON.stringify(payload)], { type: "application/json" })
        );
        if (ok) return Promise.resolve(true);
      } catch (_) {}

      // 2) fallback：fetch keepalive
      return fetch(N8N_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        mode: "cors",
        keepalive: true
      })
      .then(() => true)
      .catch(() => false);
    }

    function safeReplace(url) {
      try { window.location.replace(url); }
      catch (_) { window.location.href = url; }
    }

    // ===== 主流程 =====
    async function main() {
      const { ua, isLineBrowser, isMobile } = getUAInfo();
      const params = getAllParams();
      const { gclid, gbraid, wbraid } = params;

      // 來源標記（你 n8n 用來分流/除錯）
      const sourceTag = isLineBrowser ? "Inside_Line" : (isMobile ? "Mobile_External" : "PC_Entry");

      // --- 1) 先送一次（最多等 600ms，不拖慢跳轉） ---
      if (gclid || gbraid || wbraid) {
        const basePayload = {
          ...params,
          source: sourceTag,
          ua,
          ts: Date.now(),
          page: location.href
        };
        await withTimeout(postToN8n(basePayload), 600);
      }

      // --- 2) 分流跳轉 ---
      // A) 已經在 LINE 內建瀏覽器：嘗試拿 profile 補傳 UID，然後導去 OA 對話
      if (isLineBrowser) {
        setStatus("正在連接 LINE，請稍候...");

        try {
          await liff.init({ liffId: LIFF_ID });

          // 你目前策略：只在已登入才拿 profile，不強制 login（避免流程被打斷）
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();

            // 補傳 UID：這次要 await + timeout，避免被 replace 切掉
            await withTimeout(postToN8n({
              ...params,
              lineUserId: profile.userId,
              lineName: profile.displayName,
              source: "Mobile_Success_UID",
              ua,
              ts: Date.now(),
              page: location.href
            }), 600);
          }
        } catch (err) {
          // LIFF init/profile 失敗也不要卡住，照樣導去 OA
        }

        // 最終進 OA 對話（可帶 gclid 方便你在 OA 端做紀錄）
        const q = (gclid || gbraid || wbraid)
          ? `?gclid=${encodeURIComponent(gclid || "")}&gbraid=${encodeURIComponent(gbraid || "")}&wbraid=${encodeURIComponent(wbraid || "")}`
          : "";
        safeReplace(`https://line.me/R/ti/p/${LINE_OA_ID}${q}`);
        return;
      }

      // B) 電腦版：導去 OA（電腦通常會顯示 QR 或開 LINE）
      if (!isMobile) {
        setStatus("正在為您顯示加入方式...");
        const q = (gclid || gbraid || wbraid)
          ? `?gclid=${encodeURIComponent(gclid || "")}&gbraid=${encodeURIComponent(gbraid || "")}&wbraid=${encodeURIComponent(wbraid || "")}`
          : "";
        safeReplace(`https://line.me/R/ti/p/${LINE_OA_ID}${q}`);
        return;
      }

      // C) 手機外部瀏覽器：導去 LIFF（並把參數帶上，方便回來解析 liff.state）
      setStatus("正在開啟 LINE 預約入口...");
      const q = new URLSearchParams();
      if (gclid)  q.set("gclid", gclid);
      if (gbraid) q.set("gbraid", gbraid);
      if (wbraid) q.set("wbraid", wbraid);

      // 也帶 utm（可選）
      if (params.utm_source) q.set("utm_source", params.utm_source);
      if (params.utm_medium) q.set("utm_medium", params.utm_medium);
      if (params.utm_campaign) q.set("utm_campaign", params.utm_campaign);

      const qs = q.toString();
      safeReplace(`https://liff.line.me/${LIFF_ID}${qs ? "?" + qs : ""}`);
    }

    // 若你想「沒有任何 ads 參數就回首頁」，可以打開這段：
    // const p = getAllParams();
    // if (!p.gclid && !p.gbraid && !p.wbraid) location.href = HOME_URL;

    main();
  </script>
</body>
</html>
