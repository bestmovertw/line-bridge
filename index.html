<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在開啟 LINE...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <script>
        const LIFF_ID = "2009064962-w2XqDG82"; 
        const LINE_OA_ID = "@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        const urlParams = new URLSearchParams(window.location.search);
        const gclid = urlParams.get('gclid');

        async function main() {
            // 【核心防跳針】利用 sessionStorage 紀錄是否已經跳轉過
            // 如果這節次已經跳轉過，就直接停住，不准再次執行跳轉邏輯
            if (sessionStorage.getItem('redirected')) {
                console.log("偵測到回流，停止跳針");
                return;
            }

            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // 1. 電腦版處理 (簡單暴力，不囉唆)
            if (!isMobile) {
                if (gclid) {
                    fetch(N8N_WEBHOOK, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ gclid: gclid, source: 'PC_Direct' }),
                        keepalive: true
                    });
                }
                sessionStorage.setItem('redirected', 'true');
                setTimeout(() => {
                    window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
                }, 500);
                return;
            }

            // 2. 手機版處理
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    if (!liff.isInClient()) {
                        // 標記為已跳轉，防止被 LINE 彈回瀏覽器時再次觸發
                        sessionStorage.setItem('redirected', 'true');
                        // 強制喚醒 App
                        window.location.replace(`https://liff.line.me/${LIFF_ID}?${urlParams.toString()}`);
                    } else {
                        liff.login();
                    }
                } else {
                    const profile = await liff.getProfile();
                    if (gclid) {
                        await fetch(N8N_WEBHOOK, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lineUserId: profile.userId,
                                lineName: profile.displayName,
                                gclid: gclid,
                                source: 'Mobile_Final'
                            }),
                            keepalive: true
                        });
                    }
                    sessionStorage.setItem('redirected', 'true');
                    setTimeout(() => {
                        window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
                    }, 500);
                }
            } catch (err) {
                window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
            }
        }
        main();
    </script>
</body>
</html>
