<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在載入...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <script>
        const LIFF_ID = "2009064962-w2XqDG82"; 
        const LINE_OA_ID = "@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        // 1. 偵測環境與參數
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const urlParams = new URLSearchParams(window.location.search);
        const gclid = urlParams.get('gclid');

        async function main() {
            // 防止重複執行的旗標
            if (window.name === 'processed') return;

            // --- A. 電腦版處理 (防止跳針的核心) ---
            if (!isMobile) {
                console.log("電腦版偵測成功");
                if (gclid) {
                    // 使用 fetch 但不 await，配合 keepalive 讓它在背景傳
                    fetch(N8N_WEBHOOK, {
                        method: 'POST',
                        mode: 'no-cors', // 增加相容性
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gclid: gclid, source: 'PC_Direct' }),
                        keepalive: true
                    });
                }
                
                // 標記已處理，防止回頭又跑一次
                window.name = 'processed';
                // 延遲一秒後跳轉，給 fetch 一點點時間
                setTimeout(() => {
                    window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
                }, 800);
                return;
            }

            // --- B. 手機版處理 ---
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    if (!liff.isInClient()) {
                        // 使用 Universal Link 強制喚醒
                        window.location.replace(`https://liff.line.me/${LIFF_ID}?${urlParams.toString()}`);
                    } else {
                        liff.login();
                    }
                } else {
                    const profile = await liff.getProfile();
                    if (gclid) {
                        await fetch(N8N_WEBHOOK, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                lineUserId: profile.userId,
                                lineName: profile.displayName,
                                gclid: gclid,
                                source: 'Mobile_Success'
                            }),
                            keepalive: true
                        });
                    }
                    window.name = 'processed';
                    setTimeout(() => {
                        window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
                    }, 500);
                }
            } catch (err) {
                window.location.replace(`https://line.me/R/ti/p/${LINE_OA_ID}`);
            }
        }

        main();
    </script>
</body>
</html>
