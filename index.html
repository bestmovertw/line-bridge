<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>正在載入預約系統...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <script>
        const LIFF_ID = "2009064962-w2XqDG82"; 
        const LINE_OA_ID = "@138lkhjv"; 
        const N8N_WEBHOOK = "https://n8n.parzival0626.com/webhook/88164885-9c6f-4956-9b61-593146ec099f";

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        async function sendToN8n(data) {
            try {
                // 使用 keepalive 確保頁面跳轉時請求不會被中斷
                await fetch(N8N_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    keepalive: true 
                });
            } catch (e) {
                console.error("n8n send error", e);
            }
        }

        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const gclid = urlParams.get('gclid');

            // 1. 電腦版處理
            if (!isMobile) {
                if (gclid) {
                    await sendToN8n({ gclid: gclid, source: 'PC_Direct' });
                }
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                return;
            }

            // 2. 手機版處理
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    // 外部瀏覽器喚醒 LINE App
                    if (!liff.isInClient()) {
                        window.location.href = `https://liff.line.me/${LIFF_ID}?${urlParams.toString()}`;
                    } else {
                        liff.login();
                    }
                } else {
                    const profile = await liff.getProfile();
                    if (gclid) {
                        await sendToN8n({
                            lineUserId: profile.userId,
                            lineName: profile.displayName,
                            gclid: gclid,
                            source: 'Mobile_Success'
                        });
                    }
                    // 稍微延遲一點點確保 fetch 完成
                    setTimeout(() => {
                        window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
                    }, 300);
                }
            } catch (err) {
                window.location.href = `https://line.me/R/ti/p/${LINE_OA_ID}`;
            }
        }
        main();
    </script>
</body>
</html>
